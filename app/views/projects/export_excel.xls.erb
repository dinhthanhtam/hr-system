<?xml version="1.0"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
  xmlns:o="urn:schemas-microsoft-com:office:office"
  xmlns:x="urn:schemas-microsoft-com:office:excel"
  xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"
  xmlns:html="http://www.w3.org/TR/REC-html40">
  <ss:Styles>
    <ss:Style ss:ID="s1">
      <ss:Alignment ss:Horizontal="Center" ss:Vertical="Center"/>
      <ss:Font ss:Bold="1"/>
    </ss:Style>
    <ss:Style ss:ID="s2">
      <ss:Alignment ss:Horizontal="Center" ss:Vertical="Center"/>
    </ss:Style>
    <ss:Style ss:ID="s3">
      <ss:Interior ss:Color="#83caff" ss:Pattern="Solid"/>
      <ss:Alignment ss:Horizontal="Center" ss:Vertical="Center"/>
      <ss:Font ss:Bold="1"/>
    </ss:Style>
  </ss:Styles>
  <Worksheet ss:Name="Sheet1">
    <Table x:FullColumns="1" x:FullRows="1">
      <Column ss:Width="115" /> 
      <!-- DRAW TITLE -->
      <% @titles.each do |title| %>
        <Row>
          <Cell><Data ss:Type="String"></Data></Cell>
          <% title.each do |item| %>
            <% if item[1] > 1 %>
              <Cell ss:MergeAcross="<%= item[1] - 1 %>" ss:StyleID="s1"><Data ss:Type="String"><%= item[0] %></Data></Cell>
            <% else %>
              <Cell ss:StyleID="s1"><Data ss:Type="String"><%= item[0] %></Data></Cell>
            <% end %>
          <% end %>
        </Row>  
      <% end %>

      <% if @gantt_scale == Settings.gantt.scale_type.days %>
        <Row>
          <Cell><Data ss:Type="String"></Data></Cell>
          <% wday = DateTime.new(@titles[0][0][0], Date::MONTHNAMES.index(@titles[1][0][0]), @titles[2][0][0]).wday %>
          <% @titles.last.length.times do |n| %>
            <Cell ss:StyleID="s1"><Data ss:Type="String"><%= Settings.gantt.weekdays[(n + wday) % 7] %></Data></Cell>
          <% end %>
        </Row>
      <% end %>
      <!-- Draw process project with each user -->
      <% @list_users.each do |user| %>
        <Row>
          <Cell><Data ss:Type="String"><%= user[0] %></Data></Cell>
          <% index_in_proj = 0 %>
          <% length = 0 %>
          <% project_name = "" %>

          <% @titles.last.each_with_index do |_, index| %>
            <% user[1].each do |u| %>
              <% if u[1] == index %>
                <% index_in_proj = 1 %>
                <% length = u[2] - u[1] %>
                <% project_name = u[0] %>
              <% elsif (index > u[1] && index <= u[2]) || index > u[2] %>
                <% index_in_proj = -1 %>
              <% else %>
                <% index_in_proj = 0 %>
              <% end %>
              <!-- Draw cell with index -->
              <% case index_in_proj %>
              <% when 0 %>
                <Cell><Data ss:Type="String"></Data></Cell>
              <% when 1 %>
                <% if length > 0 %>
                  <Cell ss:StyleID="s3" ss:MergeAcross="<%= length %>"><Data ss:Type="String" ><%= project_name %></Data></Cell>
                <% else %>
                  <Cell ss:StyleID="s3"><Data ss:Type="String" ><%= project_name %></Data></Cell>
                <% end %>
              <% end %>
              <!-- Break if drew a cell for project -->
              <% break if index <= u[2] %>
            <% end %>
          <% end %>
        </Row>
      <% end %>
    </Table>
  </Worksheet>
</Workbook>