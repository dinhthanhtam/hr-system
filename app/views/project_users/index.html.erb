<div class = "list_main">
  <div class = "list_member_left">
    <div class="ctsTit">
      <h2>Assign Members</h2>
      <nav></nav>
    </div>
    <table class="list members">
      <tr>
        <th>User</th>
        <th>Roles</th>
        <th style="width:15%"></th>
      </tr>

      <% @project_users.each_with_index do |project_user, index| %>
        <tr id="member-<%= project_user.id%>" class="<%= index % 2 == 0 ? 'even' : 'odd' %> member">
          <td class="user">
            <%= project_user.user.display_name %>
          </td>
          <td class="roles">
            <span id="member-<%= project_user.id %>-roles" style=""><%= project_user.project_roles.map{ |x| x.name }.join(",") %></span>
            <%= form_for project_user, html: {style: "display:none;"}, remote: true do |f| %>
              <div style="margin:0;padding:0;display:inline">
                <%= f.select "project_role_ids", options_for_select(ProjectRole.all.map{|s| ["#{s.name}",s.id]}, project_user.project_role_ids) , {}, {class: "select option", multiple: true} %>
                <p>
                  <%= f.submit t(:button_chance, scope: [:views, :labels]), class: "btn" %>
                  <%= link_to t(:button_cancel, scope: [:views, :labels]), "#", class: "close_form", data: {id: project_user.id} %>
                </p>
              </div>
            <% end %>
          </td>
          <td class="buttons">
            <%= link_to t(:button_edit, scope: [:views, :labels]), "#", class: "icon icon-edit", data: {id: project_user.id} %>
            <%= link_to_if(@project.create_user_id!= project_user.user.id, t(:button_delete, scope: [:views, :labels]),
              url_for(action: :destroy, id: project_user.id), data: {confirm: t(:delete_confirm, scope: [:views, :messages])},
              method: :delete, class: "icon icon-delete") {} %>
          </td>
        </tr>
      <% end %>
    </table>
  </div>
  <div class = "list_member_right">
    <%= form_for @project, url: url_for(controller: :projects, action: :update, id: @project.id) do |f| %>
      <div>
        <label for="principal_search">Search for member:</label>
        <input id="principal_search" type="text" name="principal_search">
      </div>
      <div id = "principals">
        <% User.all.each do |user| %>
          <%= f.fields_for :project_users, @project.build_project_user(user.id) do |project_user_field| %>
            <% unless @project.users.map(&:id).include?(user.id) %>
              <div class = "user_name" data-id = "<%= user.display_name.downcase %>">
                <div class="project_user">
                  <%= project_user_field.check_box :_destroy, {class: "project_user_check_box"}, 0, 1 %><%= user.display_name %>
                  <%= project_user_field.hidden_field :user_id, value: user.id %>
                  <%= project_user_field.hidden_field :join_date,
                    value: (@project.activatable? ? DateTime.now.strftime("%Y-%m-%d") : @project.start_date) %>
                  <%= project_user_field.hidden_field :due_date, value: @project.due_date %>
                </div>
                <div style="display: none;" class="project_role">
                  <% ProjectRole.all.each do |role| %>
                    <%= project_user_field.fields_for :project_user_roles,
                      project_user_field.object.build_project_user_role(role.id) do |project_role_field| %>
                      <%= project_role_field.check_box :_destroy, {class: "project_role_#{role.id}"}, 0, 1 %>
                      <%= project_role_field.hidden_field :project_role_id, value: role.id %>
                    <% end %>
                  <% end %>
                </div>
              </div>
            <% end %>
          <% end %>
        <% end %>
      </div>
      <div style="margin-top:10px;">
        <p>Roles:
          <% ProjectRole.all.each do |role| %>
            <div class="project_user_role">
              <%= check_box_tag "role[]", role.id, false, class: "project_role_#{role.id}" %><%= role.name %>
            </div>
          <% end %>
        </p>
      </div>
      <%= f.submit t(:button_add, scope: [:views, :labels]), class: "btn btn-mini btn-primary" %>
    <% end %>
  </div>
</div>
